# https://www.linode.com/docs/web-servers/nginx/configure-nginx-for-optimized-performance

error_log               /var/log/nginx/error.log;
pid                     /var/run/nginx.pid;
user                    www-data;
worker_processes        auto;
worker_rlimit_nofile    10024;

events {
    use                 epoll;
    multi_accept        on;
    worker_connections  1024;
    include /etc/nginx/events.d/*.conf;
}

http {
    server_tokens       off;
    keepalive_timeout   65;
    keepalive_requests  100000;
    tcp_nopush          on;
    tcp_nodelay         on;

    client_body_buffer_size     128k;
    client_header_buffer_size   1k;
    client_header_timeout 3000;
    client_body_timeout 3000;
    client_max_body_size 32m;

    fastcgi_read_timeout 3000;
    fastcgi_buffers 8 128k;
    fastcgi_buffer_size 256k;
    # no need x-forword-for
    fastcgi_param REMOTE_ADDR $backend_client_ip;

    large_client_header_buffers 4 4k;
    output_buffers              1 32k;
    postpone_output             1460;
    send_timeout                600;

    open_file_cache             max=1000 inactive=20s;
    open_file_cache_valid       30s;
    open_file_cache_min_uses    5;
    open_file_cache_errors      off;

    include         /etc/nginx/mime.types;
    default_type    application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      '$request_length $request_time '
                      '"$upstream_response_length" "$upstream_response_time" "$host"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    gzip         on;
    # text/html does not need to be listed as it is always included by nginx.
    # WOFF files are already compressed, so application/x-font-woff is not needed.
    gzip_types   text/plain text/css application/json
                 text/javascript application/javascript application/x-javascript
                 text/xml application/xml application/xml+rss image/svg+xml
                 application/vnd.ms-fontobject application/x-font-ttf font/opentype;
    gzip_vary    on;
    gzip_disable "msie6";

    include /etc/nginx/vhost_map.conf;

    set $deploy_current_root EDIT_ME_DEPLOY_PATH/${backend_name}/current/web;

    upstream backend {
        server $backend_protocol://$backend_host:$backend_port;
    }

    # to allow it to load this large set of domains into memory and to set the rate limiting zones for the DDOS filter.
    server_names_hash_bucket_size 64;
    server_names_hash_max_size 4096;
    limit_req_zone $binary_remote_addr zone=flood:50m rate=90r/s;
    limit_conn_zone $binary_remote_addr zone=addr:50m;

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/http.d/*.conf;
    include /etc/nginx/vhosts.d/*.conf;
}
